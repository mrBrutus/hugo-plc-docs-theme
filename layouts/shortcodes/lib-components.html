{{ $tag := .Get "tag" | urlize }}
{{ $type := .Get "type" | lower }}

{{ $filter := "" }}
{{ $kind := "item" }}

{{ if eq $type "function" }}
  {{ $filter = "lib-function" }}
  {{ $kind = $type }}
{{ end}}

{{ if eq $type "function block" }}
  {{ $filter = "lib-function" }}
  {{ $kind = $type }}
{{ end}}

{{ if eq $type "data type" }}
  {{ $filter = "lib-type" }}
  {{ $kind = $type }}
{{ end}}


{{ $pages := slice }}
{{ if $tag }}
  {{ $pages = (index .Page.Site.Taxonomies.tags $tag) }}
{{ else }}
  {{/* todo: process all pages? */}}
{{ end }}

{{ with $pages }}
  {{ $table := "" }}
  {{ $itemsFound := false }}

  {{ if ne $kind "item" }}
    {{/* list selected type */}}
    {{ $table = printf "%s| | |\n" $table }}
    {{ $table = printf "%s| --- | ----------- |\n" $table }}
    {{ range where .Pages "Layout" $filter }}
      {{ $item := partial "lib/lib-item-summary" ( dict "ctx" . ) }}
      {{ if eq $item.kind $type }}
        {{ $table = printf "%s | %s | *%s* |\n" $table $item.markdownLink $item.comment }}
        {{ $itemsFound = true }}
      {{ end }}
    {{ end }}
  {{ else }}

    {{/* list all */}}
    {{ $table = printf "%s|  |  |  |\n" $table }}
    {{ $table = printf "%s| ---- | ---- | ----------- |\n" $table }}

    {{/* data types */}}
    {{ range where .Pages "Layout" "lib-type" }}
      {{ $itemsFound = true }}
      {{ $item := partial "lib/lib-item-summary" ( dict "ctx" . ) }}
      {{ $table = printf "%s| %s | %s | *%s* |\n" $table $item.kind $item.markdownLink $item.comment }}
    {{ end }}

    {{/* function blocks */}}
    {{ range where .Pages "Layout" "lib-function" }}
      {{ $item := partial "lib/lib-item-summary" ( dict "ctx" . ) }}
      {{ if eq $item.kind "function block" }}
        {{ $itemsFound = true }}
        {{ $table = printf "%s| %s | %s | *%s* |\n" $table $item.kind $item.markdownLink $item.comment }}
      {{ end }}
    {{ end }}

    {{/* functions */}}
    {{ range where .Pages "Layout" "lib-function" }}
      {{ $item := partial "lib/lib-item-summary" ( dict "ctx" . ) }}
      {{ if eq $item.kind "function" }}
        {{ $itemsFound = true }}
        {{ $table = printf "%s| %s | %s | *%s* |\n" $table $item.kind $item.markdownLink $item.comment }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ if $itemsFound }}
    {{ $table | markdownify}}
  {{ end }}
{{ end }}
